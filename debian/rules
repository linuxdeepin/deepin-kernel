#!/usr/bin/make -f
#
# Generally nothing needs to be modified below this line
#
SHELL    := sh -e
DEB_HOST_ARCH  := $(shell dpkg-architecture -qDEB_HOST_ARCH)
DEB_BUILD_ARCH := $(shell dpkg-architecture -qDEB_BUILD_ARCH)
srcver   := $(shell dpkg-parsechangelog | awk '/^Version:/ {print $$2}')
VERSION  := $(shell echo $(srcver) | sed -e 's,-[^-]*$$,,')
MAJOR    := $(word 1,$(subst ., ,$(VERSION))).$(word 2,$(subst ., ,$(VERSION)))

include debian/rules.defs

setup: debian/control $(STAMPS_DIR)/setup-stamp
$(STAMPS_DIR)/setup-stamp: $(BUILD_DIR) $(STAMPS_DIR)
	dh_testdir
	$(MAKE) -f debian/rules.gen setup-$(DEB_HOST_ARCH)
	touch $@

build: debian/control $(STAMPS_DIR)/build-stamp
$(STAMPS_DIR)/build-stamp: $(BUILD_DIR) $(STAMPS_DIR) $(STAMPS_DIR)/setup-stamp
	dh_testdir
	$(MAKE) -f debian/rules.gen build-$(DEB_HOST_ARCH)
	touch $@

$(BUILD_DIR) $(STAMPS_DIR):
	@[ -d $@ ] || mkdir $@

orig: ../orig/linux-$(MAJOR)-$(VERSION)
	rsync --delete --exclude debian --exclude .svn --link-dest=../orig/linux-$(MAJOR)-$(VERSION)/ -av ../orig/linux-$(MAJOR)-$(VERSION)/ .

../orig/linux-$(MAJOR)-$(VERSION):
	if [ -f "../linux-$(MAJOR)_$(VERSION).orig.tar.gz" ]; then \
		mkdir -p ../orig; \
		tar -C ../orig -xzf ../linux-$(MAJOR)_$(VERSION).orig.tar.gz; \
	else \
		echo "Can't find orig tarball." >&2; \
		exit 1; \
	fi

maintainerclean:
	rm -rf $(filter-out debian, $(wildcard *))

clean: debian/control
	dh_testdir
	rm -rf $(BUILD_DIR) $(STAMPS_DIR) debian/lib/python/debian_linux/*.pyc
	dh_clean

binary-indep: build
	dh_testdir
	$(MAKE) -f debian/rules.gen binary-indep

binary-arch: build
	dh_testdir
	$(MAKE) -f debian/rules.gen binary-arch-$(DEB_HOST_ARCH)

binary:	binary-indep binary-arch

#
# Makes the master debian/control file by substituting
# variable values into the template.
#
CONTROL_FILES = debian/changelog $(wildcard debian/templates/control.*) 
CONTROL_FILES += debian/arch/defines $(wildcard debian/arch/*/defines) $(wildcard debian/arch/*/*/defines)
debian/control debian/rules.gen: debian/bin/gencontrol.py $(CONTROL_FILES)
	if [ -f debian/control.md5sum ]; then \
		if md5sum $^ | diff - debian/control.md5sum > /dev/null; then true; else \
			$(MAKE) -f debian/rules debian/control-real; \
		fi \
	else \
		$(MAKE) -f debian/rules debian/control-real; \
	fi

debian/control-real: debian/bin/gencontrol.py $(CONTROL_FILES)
	chmod +x $<
	$<
	md5sum $^ > debian/control.md5sum
	@echo
	@echo This target is made to fail intentionally, to make sure
	@echo that it is NEVER run during the automated build. Please
	@echo ignore the following error, the debian/control file has
	@echo been generated SUCCESSFULLY.
	@echo
	exit 1

#
# Rule to check all configs snipplets in debian/arch
#

CheckConfs_DIR := $(CURDIR)/debian/build/check
CheckConfs_srcfiles := $(filter-out debian, $(wildcard *))
CheckConfs_SOURCE_VERSION := ${shell a=`head -n 1 debian/changelog`; a=$${a%%\)*}; a=$${a\#\#*\(}; echo $$a}
CheckConfs_REVISIONS := ${shell a=$(CheckConfs_SOURCE_VERSION); a=$${a\#\#*-}; b=1; while [ $$b -lt $$a ]; do echo -n "$$b "; b=$$(($$b+1)); done; echo $$b}

$(CheckConfs_DIR) source-configs:
	rm -rf '$(CheckConfs_DIR)'
	mkdir -p '$(CheckConfs_DIR)'
	cp -al $(CheckConfs_srcfiles) $(CheckConfs_DIR)

patch-configs: $(CheckConfs_DIR)
	cd '$(CheckConfs_DIR)'; python2.4 '$(CURDIR)/debian/bin/apply.py' \
		--overwrite-home='$(CURDIR)/debian/patches' \
		--overwrite-source='$(CheckConfs_SOURCE_VERSION)' \
		--overwrite-revisions='$(CheckConfs_REVISIONS)' \


check-configs: patch-configs
	@echo "Checking all configuration files"
	ocaml debian/bin/kconfig.ml -c -b "debian/arch"

clean-configs:
	rm -rf '$(CheckConfs_DIR)'

.PHONY: clean build setup binary-indep binary-arch binary
