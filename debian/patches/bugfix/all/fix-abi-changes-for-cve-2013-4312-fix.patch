From: Ben Hutchings <ben@decadent.org.uk>
Date: Sun, 17 Jan 2016 15:55:02 +0000
Subject: Fix ABI changes for CVE-2013-4312
Forwarded: not-needed

The fixes for CVE-2013-4312 added new structure members,
user_struct::{unix_inflight,pipe_bufs}.  As this is always allocated in
kernel/user.c and the new member is only used by af_unix which is also
built-in, we can safely add new members at the end.  So move it to the
end and hide it from genksyms.

Similarly for pipe_inode_info::user.

---
--- a/include/linux/sched.h
+++ b/include/linux/sched.h
@@ -830,8 +830,6 @@ struct user_struct {
 	unsigned long mq_bytes;	/* How many bytes can be allocated to mqueue? */
 #endif
 	unsigned long locked_shm; /* How many pages of mlocked shm ? */
-	unsigned long unix_inflight;	/* How many files in flight in unix sockets */
-	atomic_long_t pipe_bufs;  /* how many pages are allocated in pipe buffers */
 
 #ifdef CONFIG_KEYS
 	struct key *uid_keyring;	/* UID specific keyring */
@@ -845,6 +843,11 @@ struct user_struct {
 #ifdef CONFIG_PERF_EVENTS
 	atomic_long_t locked_vm;
 #endif
+
+#ifndef __GENKSYMS__
+	unsigned long unix_inflight;	/* How many files in flight in unix sockets */
+	atomic_long_t pipe_bufs;  /* how many pages are allocated in pipe buffers */
+#endif
 };
 
 extern int uids_sysfs_init(void);
--- a/include/linux/pipe_fs_i.h
+++ b/include/linux/pipe_fs_i.h
@@ -58,7 +58,9 @@ struct pipe_inode_info {
 	struct fasync_struct *fasync_readers;
 	struct fasync_struct *fasync_writers;
 	struct pipe_buffer *bufs;
+#ifndef __GENKSYMS__
 	struct user_struct *user;
+#endif
 };
 
 /*
