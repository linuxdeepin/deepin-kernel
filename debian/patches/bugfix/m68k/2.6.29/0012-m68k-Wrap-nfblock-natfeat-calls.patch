From 419d1b9d8d116b251094e3ce1f3ba4ef8ab54ec6 Mon Sep 17 00:00:00 2001
From: Geert Uytterhoeven <geert@linux-m68k.org>
Date: Tue, 18 Nov 2008 21:02:20 +0100
Subject: [PATCH 12/90] m68k: Wrap nfblock natfeat calls

Add wrappers with proper prototypes for the natfeat calls in nfblock.
This fixes the problem where sector_t was pushed on the stack as a 64-bit value
if CONFIG_LBD=y, while all parameters of the nf_call() varargs function are
32-bit.

Signed-off-by: Geert Uytterhoeven <geert@linux-m68k.org>
---
 arch/m68k/emu/nfblock.c |   20 +++++++++++++++++---
 1 files changed, 17 insertions(+), 3 deletions(-)

diff --git a/arch/m68k/emu/nfblock.c b/arch/m68k/emu/nfblock.c
index 3d987c7..c131121 100644
--- a/arch/m68k/emu/nfblock.c
+++ b/arch/m68k/emu/nfblock.c
@@ -30,6 +30,20 @@ enum {
 	NFHD_DEV_OFFSET = 8,
 };
 
+static inline s32 nfhd_read_write(u32 major, u32 minor, u32 rwflag, u32 recno,
+				  u32 count, u32 buf)
+{
+	return nf_call(nfhd_id + NFHD_READ_WRITE, major, minor, rwflag, recno,
+		       count, buf);
+}
+
+static inline s32 nfhd_get_capacity(u32 major, u32 minor, u32 *blocks,
+				    u32 *blocksize)
+{
+	return nf_call(nfhd_id + NFHD_GET_CAPACITY, major, minor, blocks,
+		       blocksize);
+}
+
 static LIST_HEAD(nfhd_list);
 
 static int major_num;
@@ -56,8 +70,8 @@ static int nfhd_make_request(struct request_queue *queue, struct bio *bio)
 	bio_for_each_segment(bvec, bio, i) {
 		len = bvec->bv_len;
 		len >>= 9;
-		nf_call(nfhd_id + NFHD_READ_WRITE, dev->id, 0, dir,
-			sec >> shift, len >> shift, bvec_to_phys(bvec));
+		nfhd_read_write(dev->id, 0, dir, sec >> shift, len >> shift,
+				bvec_to_phys(bvec));
 		sec += len;
 	}
 	bio_endio(bio, 0);
@@ -152,7 +166,7 @@ static int __init nfhd_init(void)
 	}
 
 	for (i = NFHD_DEV_OFFSET; i < 24; i++) {
-		if (nf_call(nfhd_id + NFHD_GET_CAPACITY, i, 0, &blocks, &bsize))
+		if (nfhd_get_capacity(i, 0, &blocks, &bsize))
 			continue;
 		nfhd_init_one(i, blocks, bsize);
 	}
-- 
1.6.2.3

